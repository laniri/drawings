# Embedding Service Contract

## Overview
Service contract for Embedding Service (service)

**Source File**: `app/services/embedding_service.py`

## Interface Specification

### Classes

#### EmbeddingServiceError

Base exception for embedding service errors.

**Inherits from**: Exception

#### ModelLoadingError

Raised when model loading fails.

**Inherits from**: EmbeddingServiceError

#### EmbeddingGenerationError

Raised when embedding generation fails.

**Inherits from**: EmbeddingServiceError

#### DeviceManager

Manages GPU/CPU device detection and selection.

#### VisionTransformerWrapper

Wrapper for Vision Transformer model with caching and optimization.

#### EmbeddingService

Service for generating embeddings from children's drawings using Vision Transformers.

#### EmbeddingPipeline

High-level pipeline for processing drawings and generating embeddings.

## Methods

### device

Get the current device.

**Signature**: `device() -> torch.device`

**Type**: Property

**Returns**: `torch.device`

### device_info

Get device information.

**Signature**: `device_info() -> Dict`

**Type**: Property

**Returns**: `Dict`

### get_memory_usage

Get current memory usage if available.

**Signature**: `get_memory_usage() -> Optional[Dict]`

**Returns**: `Optional[Dict]`

### load_model

Load the Vision Transformer model with optional caching.

**Signature**: `load_model(use_cache: bool) -> None`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `use_cache` | `bool` | Parameter description |

**Returns**: `None`

### is_loaded

Check if the model is loaded and ready.

**Signature**: `is_loaded() -> bool`

**Returns**: `bool`

### get_model_info

Get information about the loaded model.

**Signature**: `get_model_info() -> Dict`

**Returns**: `Dict`

### initialize

Initialize the embedding service by loading the model.

**Signature**: `initialize(use_cache: bool) -> None`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `use_cache` | `bool` | Parameter description |

**Returns**: `None`

### is_ready

Check if the service is ready to generate embeddings.

**Signature**: `is_ready() -> bool`

**Returns**: `bool`

### get_service_info

Get comprehensive service information.

**Signature**: `get_service_info() -> Dict`

**Returns**: `Dict`

### generate_embedding

Generate embedding for a single image.

Args:
    image: PIL Image or numpy array
    age: Optional age information to concatenate
    use_cache: Whether to use caching for embeddings
    
Returns:
    numpy array containing the embedding vector

**Signature**: `generate_embedding(image: Union[<ast.Attribute object at 0x1104440d0>, <ast.Attribute object at 0x110447c10>], age: Optional[float], use_cache: bool) -> np.ndarray`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `image` | `Union[<ast.Attribute object at 0x1104440d0>, <ast.Attribute object at 0x110447c10>]` | Parameter description |
| `age` | `Optional[float]` | Parameter description |
| `use_cache` | `bool` | Parameter description |

**Returns**: `np.ndarray`

### generate_batch_embeddings

Generate embeddings for multiple images in batches.

Args:
    images: List of PIL Images or numpy arrays
    ages: Optional list of ages corresponding to images
    batch_size: Number of images to process in each batch
    use_cache: Whether to use caching for embeddings
    
Returns:
    List of numpy arrays containing embedding vectors

**Signature**: `generate_batch_embeddings(images: <ast.Subscript object at 0x1105a8850>, ages: <ast.Subscript object at 0x110386550>, batch_size: int, use_cache: bool) -> <ast.Subscript object at 0x110426450>`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `images` | `<ast.Subscript object at 0x1105a8850>` | Parameter description |
| `ages` | `<ast.Subscript object at 0x110386550>` | Parameter description |
| `batch_size` | `int` | Parameter description |
| `use_cache` | `bool` | Parameter description |

**Returns**: `<ast.Subscript object at 0x110426450>`

### get_embedding_dimension

Get the dimension of embeddings generated by this service.

**Signature**: `get_embedding_dimension(include_age: bool) -> int`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `include_age` | `bool` | Parameter description |

**Returns**: `int`

### clear_cache

Clear the embedding cache.

**Signature**: `clear_cache() -> None`

**Returns**: `None`

### store_embedding_for_db

Store an embedding for database persistence with serialization.

Args:
    drawing_id: Database ID of the drawing
    embedding: Embedding array to store
    age: Optional age information
    model_type: Type of model used for embedding
    
Returns:
    Tuple of (serialized_bytes, dimension)

**Signature**: `store_embedding_for_db(drawing_id: int, embedding: np.ndarray, age: Optional[float], model_type: str) -> Tuple[bytes, int]`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `drawing_id` | `int` | Parameter description |
| `embedding` | `np.ndarray` | Parameter description |
| `age` | `Optional[float]` | Parameter description |
| `model_type` | `str` | Parameter description |

**Returns**: `Tuple[bytes, int]`

### retrieve_embedding_from_db

Retrieve an embedding from database with caching support.

Args:
    drawing_id: Database ID of the drawing
    serialized_data: Serialized embedding data from database
    age: Optional age information
    model_type: Type of model used for embedding
    
Returns:
    Embedding array or None if not found

**Signature**: `retrieve_embedding_from_db(drawing_id: int, serialized_data: Optional[bytes], age: Optional[float], model_type: str) -> <ast.Subscript object at 0x1104e1050>`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `drawing_id` | `int` | Parameter description |
| `serialized_data` | `Optional[bytes]` | Parameter description |
| `age` | `Optional[float]` | Parameter description |
| `model_type` | `str` | Parameter description |

**Returns**: `<ast.Subscript object at 0x1104e1050>`

### invalidate_embedding_cache

Invalidate cached embedding for a specific drawing.

Args:
    drawing_id: Database ID of the drawing
    age: Optional age information
    model_type: Type of model used for embedding
    
Returns:
    True if cache entry was removed

**Signature**: `invalidate_embedding_cache(drawing_id: int, age: Optional[float], model_type: str) -> bool`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `drawing_id` | `int` | Parameter description |
| `age` | `Optional[float]` | Parameter description |
| `model_type` | `str` | Parameter description |

**Returns**: `bool`

### get_storage_stats

Get embedding storage and cache statistics.

**Signature**: `get_storage_stats() -> Dict[str, Any]`

**Returns**: `Dict[str, Any]`

### process_drawing

Process a single drawing through the complete embedding pipeline.

Args:
    image: PIL Image or numpy array
    age: Optional age information
    drawing_id: Optional database ID for tracking
    use_cache: Whether to use embedding cache
    
Returns:
    Dictionary containing embedding and metadata

**Signature**: `process_drawing(image: Union[<ast.Attribute object at 0x110435750>, <ast.Attribute object at 0x110435e10>], age: Optional[float], drawing_id: Optional[int], use_cache: bool) -> Dict`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `image` | `Union[<ast.Attribute object at 0x110435750>, <ast.Attribute object at 0x110435e10>]` | Parameter description |
| `age` | `Optional[float]` | Parameter description |
| `drawing_id` | `Optional[int]` | Parameter description |
| `use_cache` | `bool` | Parameter description |

**Returns**: `Dict`

### process_batch

Process multiple drawings through the embedding pipeline.

Args:
    images: List of PIL Images or numpy arrays
    ages: Optional list of ages
    drawing_ids: Optional list of database IDs
    batch_size: Batch size for processing
    use_cache: Whether to use embedding cache
    
Returns:
    List of result dictionaries

**Signature**: `process_batch(images: <ast.Subscript object at 0x1104cecd0>, ages: <ast.Subscript object at 0x1104ce090>, drawing_ids: <ast.Subscript object at 0x1104cfb50>, batch_size: int, use_cache: bool) -> List[Dict]`

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `images` | `<ast.Subscript object at 0x1104cecd0>` | Parameter description |
| `ages` | `<ast.Subscript object at 0x1104ce090>` | Parameter description |
| `drawing_ids` | `<ast.Subscript object at 0x1104cfb50>` | Parameter description |
| `batch_size` | `int` | Parameter description |
| `use_cache` | `bool` | Parameter description |

**Returns**: `List[Dict]`

### get_pipeline_stats

Get pipeline processing statistics.

**Signature**: `get_pipeline_stats() -> Dict`

**Returns**: `Dict`

### reset_stats

Reset pipeline statistics.

**Signature**: `reset_stats() -> None`

**Returns**: `None`

## Defined Interfaces

### DeviceManagerInterface

**Type**: Protocol
**Implemented by**: DeviceManager

**Methods**:

- `device() -> torch.device`
- `device_info() -> Dict`
- `get_memory_usage() -> Optional[Dict]`

### VisionTransformerWrapperInterface

**Type**: Protocol
**Implemented by**: VisionTransformerWrapper

**Methods**:

- `load_model(use_cache: bool) -> None`
- `is_loaded() -> bool`
- `get_model_info() -> Dict`

### EmbeddingServiceInterface

**Type**: Protocol
**Implemented by**: EmbeddingService

**Methods**:

- `initialize(use_cache: bool) -> None`
- `is_ready() -> bool`
- `get_service_info() -> Dict`
- `generate_embedding(image: Union[<ast.Attribute object at 0x1104440d0>, <ast.Attribute object at 0x110447c10>], age: Optional[float], use_cache: bool) -> np.ndarray`
- `generate_batch_embeddings(images: <ast.Subscript object at 0x1105a8850>, ages: <ast.Subscript object at 0x110386550>, batch_size: int, use_cache: bool) -> <ast.Subscript object at 0x110426450>`
- `get_embedding_dimension(include_age: bool) -> int`
- `clear_cache() -> None`
- `store_embedding_for_db(drawing_id: int, embedding: np.ndarray, age: Optional[float], model_type: str) -> Tuple[bytes, int]`
- `retrieve_embedding_from_db(drawing_id: int, serialized_data: Optional[bytes], age: Optional[float], model_type: str) -> <ast.Subscript object at 0x1104e1050>`
- `invalidate_embedding_cache(drawing_id: int, age: Optional[float], model_type: str) -> bool`
- `get_storage_stats() -> Dict[str, Any]`

### EmbeddingPipelineInterface

**Type**: Protocol
**Implemented by**: EmbeddingPipeline

**Methods**:

- `process_drawing(image: Union[<ast.Attribute object at 0x110435750>, <ast.Attribute object at 0x110435e10>], age: Optional[float], drawing_id: Optional[int], use_cache: bool) -> Dict`
- `process_batch(images: <ast.Subscript object at 0x1104cecd0>, ages: <ast.Subscript object at 0x1104ce090>, drawing_ids: <ast.Subscript object at 0x1104cfb50>, batch_size: int, use_cache: bool) -> List[Dict]`
- `get_pipeline_stats() -> Dict`
- `reset_stats() -> None`

## Usage Examples

```python
# Example usage of the service contract
# TODO: Add specific usage examples
```

## Validation

This contract is automatically validated against the implementation in:
- Source file: `app/services/embedding_service.py`
- Last validated: 2025-12-16 15:47:04

